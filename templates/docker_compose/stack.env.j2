{# ========================================================== #}
{#    stack.env - Geheime Umgebungsvariablen (Secrets)        #}
{# ========================================================== #}

{# --- 1. Secrets des Haupt-Services --- #}
{% for key, value in deployments.docker_compose.stack_env.items() %}
{{ key }}="{{ value | string }}"
{% endfor %}

{# --- 2. Secrets der Dependencies --- #}
{% if dependencies is defined and dependencies %}
{#- Erstelle eine gefilterte Liste von Dependencies, die tatsächlich Geheimnisse haben -#}
{% set secret_deps = [] %}
{% for dep_name, dep_config in dependencies.items() %}
    {% if dep_config.environment is defined %}
        {% for key, value in dep_config.environment.items() %}
            {% if 'password' in key|lower or 'secret' in key|lower or 'token' in key|lower or 'key' in key|lower %}
                {% if secret_deps.append(1) %}{% endif %}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endfor %}

{#- Füge eine Trennzeile hinzu, WENN beide Sektionen (Haupt-Service und Dependencies) Inhalt haben -#}
{% if deployments.docker_compose.stack_env and secret_deps %}

# --- Dependencies Secrets ---
{% endif %}
{#- Gib die gefilterten Geheimnisse der Dependencies aus -#}
{% for dep_name, dep_config in dependencies.items() %}
{%   if dep_config.environment is defined %}
{%     for key, value in dep_config.environment.items() %}
{#- Secrets werden anhand von Schlüsselwörtern im Variablennamen identifiziert -#}
{%       if 'password' in key|lower or 'secret' in key|lower or 'token' in key|lower or 'key' in key|lower %}
{{ key }}="{{ value | string }}"
{%       endif %}
{%     endfor %}
{%   endif %}
{% endfor %}
{% endif %}