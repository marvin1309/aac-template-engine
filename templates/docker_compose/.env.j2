{# --- Main Service Environment Variables --- #}
{%- for key, value in deployments.docker_compose.dot_env.items() %}
{%- set val_str = value | string %}
{#- If the value is a JSON object or a boolean-like string, don't wrap it in extra quotes. Otherwise, do. -#}
{%- if (val_str.startswith('{') and val_str.endswith('}')) or (val_str in ['True', 'False', 'true', 'false']) %}
{{ key }}={{ val_str }}
{%- else %}
{{ key }}="{{ value | string }}"
{%- endif %}
{% endfor %}

{# --- Dependencies Environment Variables (non-secrets) --- #}
{%- if dependencies is defined and dependencies %}

{#- Add a newline for separation if both sections have content -#}
{%- if deployments.docker_compose.dot_env and dependencies.values() | selectattr('environment') | list | length > 0 %}
{% endif %}
{%- for dep_name, dep_config in dependencies.items() %}
{%- if dep_config.environment is defined %}
{%- for key, value in dep_config.environment.items() if 'secret' not in value and 'password' not in key|lower and 'token' not in key|lower %}
{{ key }}="{{ value | string }}"
{% endfor %}
{%- endif %}
{%- endfor %}
{%- endif %}