{# ========================================================== #}
{#    .env - Nicht-geheime Umgebungsvariablen                #}
{# ========================================================== #}

{# --- 1. Umgebungsvariablen des Haupt-Services --- #}
{% for key, value in deployments.docker_compose.dot_env.items() %}
{%- set val_str = value | string %}
{#- Deine Logik für JSON: Wenn der Wert wie ein JSON-Objekt aussieht, füge keine zusätzlichen Anführungszeichen hinzu. -#}
{%- if val_str.strip().startswith('{') and val_str.strip().endswith('}') %}
{{ key }}={{ val_str }}
{%- else %}
{{ key }}="{{ val_str }}"
{%- endif %}
{% endfor %}

{# --- 2. Umgebungsvariablen der Dependencies (nur Nicht-Geheimnisse) --- #}
{% if dependencies is defined and dependencies %}
{#- Erstelle eine gefilterte Liste von Dependencies, die tatsächlich Nicht-Geheimnisse haben -#}
{% set non_secret_deps = [] %}
{% for dep_name, dep_config in dependencies.items() %}
    {% if dep_config.environment is defined %}
        {% for key, value in dep_config.environment.items() %}
            {% if not ('password' in key|lower or 'secret' in key|lower or 'token' in key|lower or 'key' in key|lower) %}
                {% if non_secret_deps.append(1) %}{% endif %}
            {% endif %}
        {% endfor %}
    {% endif %}
{% endfor %}

{#- Füge eine Trennzeile hinzu, WENN beide Sektionen (Haupt-Service und Dependencies) Inhalt haben -#}
{% if deployments.docker_compose.dot_env and non_secret_deps %}

# --- Dependencies Environment Variables (non-secrets) ---
{% endif %}
{#- Gib die gefilterten Nicht-Geheimnisse der Dependencies aus -#}
{% for dep_name, dep_config in dependencies.items() %}
{%   if dep_config.environment is defined %}
{%     for key, value in dep_config.environment.items() %}
{#- Die Logik hier ist das genaue Gegenteil von stack.env.j2, um Duplikate zu vermeiden -#}
{%       if not ('password' in key|lower or 'secret' in key|lower or 'token' in key|lower or 'key' in key|lower) %}
{{ key }}="{{ value | string }}"
{%       endif %}
{%     endfor %}
{%   endif %}
{% endfor %}
{% endif %}