# This is a reusable GitLab CI/CD pipeline for service repositories.
# It automates a full GitOps lifecycle for each environment:
# Generate -> Validate -> Commit -> Deploy.

default:
  tags:
    - docker

stages:
  - dev-generate
  - dev-validate
  - dev-commit
  - dev-deploy
  - test-generate
  - test-validate
  - test-commit
  - test-deploy
  - prod-promote
  - prod-deploy
  - documentation

# ==========================================================================
# REUSABLE TEMPLATES (.generate-base, .validate-base, .commit-artifacts)
# ==========================================================================

.generate-base:
  image: python:3.9-slim
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends git
    - pip install PyYAML Jinja2
    - git clone "https://gitlab-ci-token:${CI_GITLAB_TOKEN_GLOBAL_FESER}@${CI_SERVER_HOST}/aac-application-definitions/aac-template-engine.git"
  artifacts:
    paths: [deployments/]
    expire_in: 1 hour
  rules:
    # This rule is a placeholder and should be overridden in the concrete jobs
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_MESSAGE !~ /\[skip ci\]/'

.validate-base:
  image: docker:latest
  services: [docker:dind]
  script:
    - apk add --no-cache docker-compose
    - docker-compose -f deployments/docker_compose/docker-compose.yml config
  rules:
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_MESSAGE !~ /\[skip ci\]/'

.commit-artifacts:
  image: alpine:latest
  before_script:
    - apk add --no-cache git
    - git config --global user.email "ci-bot@${CI_SERVER_HOST}"
    - git config --global user.name "GitLab CI Re-committer"
    - git remote set-url origin "https://gitlab-ci-token:${CI_GITLAB_TOKEN_GLOBAL_FESER}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"
    - git checkout $CI_COMMIT_BRANCH
  script:
    - git add deployments/
    - |
      if ! git diff --staged --quiet; then
        echo "Changes detected in generated artifacts. Committing..."
        # The [skip ci] tag is crucial to prevent pipeline loops!
        git commit -m "ci: Re-commit ${CI_COMMIT_BRANCH} artifacts [skip ci]"
        git push origin $CI_COMMIT_BRANCH
      else
        echo "No changes in generated artifacts to re-commit."
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_MESSAGE !~ /\[skip ci\]/'

# ==========================================================================
# DEV WORKFLOW (runs on 'dev' branch)
# ==========================================================================
dev-generate-docker-compose:
  extends: .generate-base
  stage: dev-generate
  script:
    - SSOT_JSON=$(python3 -c 'import sys, yaml, json; print(json.dumps(yaml.safe_load(sys.stdin)))' < service.yml)
    - python3 aac-template-engine/scripts/generate_manifest.py --ssot-json "$SSOT_JSON" --template-path aac-template-engine --deployment-type "docker_compose" --stage "dev"
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev" && $CI_COMMIT_MESSAGE !~ /\[skip ci\]/'

dev-generate-custom-files:
  extends: .generate-base
  stage: dev-generate
  script:
    - SSOT_JSON=$(python3 -c 'import sys, yaml, json; print(json.dumps(yaml.safe_load(sys.stdin)))' < service.yml)
    - python3 aac-template-engine/scripts/generate_manifest.py --ssot-json "$SSOT_JSON" --template-path aac-template-engine --process-files --stage "dev"
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev" && $CI_COMMIT_MESSAGE !~ /\[skip ci\]/'
      exists: [custom_templates/files/**/*]

dev-validate-docker-compose:
  extends: .validate-base
  stage: dev-validate
  needs: [dev-generate-docker-compose]
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev" && $CI_COMMIT_MESSAGE!~ /ci:/'

# ==========================================================================
# STAGE 3: DEV COMMIT (runs on dev branch)
# ==========================================================================
.promote-base:
  stage: dev-commit
  image: python:3.9-slim
  before_script:
    - apt-get update && apt-get install -y --no-install-recommends git
    - pip install PyYAML
    - git clone "https://gitlab-ci-token:${CI_GITLAB_TOKEN_GLOBAL_FESER}@${CI_SERVER_HOST}/aac-application-definitions/aac-template-engine.git"
  variables:
    IAC_CONTROLLER_REPO_URL: "https://gitlab.int.fam-feser.de/iac-environment/iac-controller.git" # The URL to the central inventory repository.

dev-promote-and-deploy:
  extends: .promote-base
  needs:
    - dev-validate-docker-compose
    - job: dev-generate-custom-files
      optional: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev" && $CI_COMMIT_MESSAGE !~ /\[skip ci\]/'

dev-deploy:
  stage: dev-deploy
  needs: [dev-commit]
  trigger:
    project: 'iac-environment/iac-ansible-automation'
    branch: main
    strategy: depend
  variables:
    SERVICE_NAME: $CI_PROJECT_NAME
    SERVICE_BRANCH: 'dev'
    DEPLOYMENT_TYPE: 'single_service_trigger'
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev" && $CI_COMMIT_MESSAGE !~ /\[skip ci\]/'

# ==========================================================================
# STAGE 4: DEV DEPLOY (triggers downstream)
# ==========================================================================
dev-deploy:
  stage: dev-deploy
  needs: [dev-promote]
  trigger:
    project: 'iac-environment/iac-ansible-automation'
    branch: main
    strategy: depend
  variables:
    SERVICE_NAME: $CI_PROJECT_NAME
    SERVICE_BRANCH: 'dev'
    DEPLOYMENT_TYPE: 'single_service_trigger'
  rules:
    - if: '$CI_COMMIT_BRANCH == "dev" && $CI_COMMIT_MESSAGE!~ /ci:/'

# ==========================================================================
# TEST WORKFLOW (runs on 'test' branch)
# ==========================================================================
# This job is now manual. A user can click it to create the 'test' branch
# and promote the service to the 'test' stage in the central inventory.
test-promote:
  stage: test-promote
  extends: .promote-base
  needs: [dev-promote-and-deploy]
  script:
    - SSOT_JSON=$(python3 -c 'import sys, yaml, json; print(json.dumps(yaml.safe_load(sys.stdin)))' < service.yml)
    - python3 aac-template-engine/scripts/generate_manifest.py --ssot-json "$SSOT_JSON" --template-path aac-template-engine --process-files --stage "test"
  rules:
    - if: '$CI_COMMIT_BRANCH == "test" && $CI_COMMIT_MESSAGE !~ /\[skip ci\]/'
      exists: [custom_templates/files/**/*]

test-validate-docker-compose:
  extends: .validate-base
  stage: test-validate
  needs: [test-generate-docker-compose]
  rules:
    - if: '$CI_COMMIT_BRANCH == "test" && $CI_COMMIT_MESSAGE !~ /\[skip ci\]/'

test-commit:
  extends: .commit-artifacts
  stage: test-commit
  needs:
    - test-validate-docker-compose
    - job: test-generate-custom-files
      optional: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "test" && $CI_COMMIT_MESSAGE !~ /\[skip ci\]/'

# ==========================================================================
# STAGE 6: TEST DEPLOY (runs on test branch)
# ==========================================================================
test-deploy:
  stage: test-deploy
  needs: [test-commit]
  trigger:
    project: 'iac-environment/iac-ansible-automation'
    branch: main
    strategy: depend
  variables:
    SERVICE_NAME: $CI_PROJECT_NAME
    SERVICE_BRANCH: 'test'
    DEPLOYMENT_TYPE: 'single_service_trigger'
  rules:
    - if: '$CI_COMMIT_BRANCH == "test" && $CI_COMMIT_MESSAGE !~ /\[skip ci\]/'

# ==========================================================================
# PROD WORKFLOW (runs on 'main' branch)
# ==========================================================================
prod-promote:
  stage: prod-promote
  extends: .promote-base
  needs: [test-deploy]
  script:
    - echo "Creating main branch from test..."
    - git fetch origin test
    - git checkout -B main origin/test
    - git push -f origin main
    - echo "Promoting service to prod environment..."
    - >
      python aac-template-engine/scripts/promote_service.py
      --service-name "$CI_PROJECT_NAME"
      --service-git-repo "$CI_PROJECT_URL.git"
      --target-stage "prod"
      --iac-controller-repo-url "$IAC_CONTROLLER_REPO_URL"
      --iac-controller-token "$CI_GITLAB_TOKEN_GLOBAL_FESER"
  rules:
    - if: '$CI_COMMIT_BRANCH == "test"'

prod-deploy:
  stage: prod-deploy
  needs: [prod-commit]
  trigger:
    project: 'iac-environment/iac-ansible-automation'
    branch: main
    strategy: depend
  variables:
    SERVICE_NAME: $CI_PROJECT_NAME
    SERVICE_BRANCH: 'main'
    DEPLOYMENT_TYPE: 'single_service_trigger'
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
      allow_failure: false

# ==========================================================================
# DOCUMENTATION WORKFLOW
# ==========================================================================
publish_to_docs:
  stage: documentation
  image: alpine:latest
  needs: [prod-deploy]
  variables:
    DOCS_REPO_URL: "https://gitlab.int.fam-feser.de/documentation/aac-iac-documentation.git"
  script:
    # Der Skript-Inhalt bleibt unverändert, da er bereits gut funktioniert hat.
    - |
      if [ ! -f "documentation.md" ]; then
        echo "Keine 'documentation.md' in diesem Repository gefunden. Überspringe Dokumentations-Update."
        exit 0
      fi
      
      echo "Klone das Dokumentations-Repository..."
      apk add --no-cache git
      git config --global user.email "ci-bot@${CI_SERVER_HOST}"
      git config --global user.name "GitLab CI Documentation Bot"
      git clone "https://gitlab-ci-token:${DOCS_REPO_TOKEN}@$(echo "$DOCS_REPO_URL" | sed 's|https://||')" docs_repo
      cd docs_repo

      DOC_DIR="site/content/aac-services/${CI_PROJECT_NAME}"
      DOC_FILE="${DOC_DIR}/${CI_PROJECT_NAME}-documentation.md"
      mkdir -p "${DOC_DIR}"

      echo "Erstelle die Dokumentationsdatei mit Hugo-Header..."
      {
        echo "---";
        echo "title: \"Dokumentation: ${CI_PROJECT_NAME}\"";
        echo "date: $(date -u +'%Y-%m-%dT%H:%M:%SZ')";
        echo "lastmod: $(date -u +'%Y-%m-%dT%H:%M:%SZ')";
        echo "draft: false";
        echo "description: \"Automatisch generierte Service-Dokumentation für ${CI_PROJECT_NAME}.\"";
        echo "---";
        echo "";
        cat ../documentation.md;
      } > "${DOC_FILE}"

      git add "${DOC_FILE}"
      if ! git diff --staged --quiet; then
        git commit -m "docs: Aktualisiere Service-Dokumentation für ${CI_PROJECT_NAME}"
        git push origin main
      else
        echo "Keine Änderungen an der Dokumentation."
      fi
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
      allow_failure: false