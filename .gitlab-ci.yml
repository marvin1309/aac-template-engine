stages:
  - test

.test-template:
  stage: test
  image: python:3.9-slim
  before_script:
    - pip install PyYAML Jinja2
  after_script:
    # Clean up the generated files after the job
    - rm -rf tests/service-test/deployments
  tags:
    - docker

test-docker-compose-generation:
  extends: .test-template
  script:
    - |
      echo "ğŸ§ª Testing docker-compose generation..."
      
      # Navigate into the test service directory
      cd tests/service-test
      
      echo "âš™ï¸ Converting to JSON and running manifest generator..."
      BOOKSTACK_SERVICE_JSON="$(python -c 'import sys, yaml, json; print(json.dumps(yaml.safe_load(sys.stdin)))' < service.yml)"
      python ../../scripts/generate_manifest.py --ssot-json "$BOOKSTACK_SERVICE_JSON" --template-path ../.. --deployment-type docker_compose
      
      echo "ğŸ” Verifying generated files for BookStack..."
      test -f deployments/docker_compose/docker-compose.yml || (echo "docker-compose.yml not found!" && exit 1)
      test -f deployments/docker_compose/.env || (echo ".env file not found!" && exit 1)
      test -f deployments/docker_compose/stack.env || (echo "stack.env file not found!" && exit 1)
      
      # Verifying content of generated files
      grep -q 'image: lscr.io/linuxserver/bookstack' deployments/docker_compose/docker-compose.yml
      # FIXED: Changed colon to equals sign to match the .env file format
      grep -q 'DB_DATABASE="bookstack"' deployments/docker_compose/.env
      grep -q 'DB_PASSWORD=' deployments/docker_compose/stack.env
      
      echo "âœ… BookStack Docker Compose generation test passed."
  tags:
    - docker